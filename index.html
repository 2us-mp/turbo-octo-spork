<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Charmers Checkout</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<script src="https://js.stripe.com/v3/"></script>
<script src="https://www.google.com/recaptcha/enterprise.js?render=6LeT6JArAAAAAKZDUSTu8Krw6i1sQshZnbgMoLvO"></script>
<style>
  body{font-family:"Poppins",sans-serif;background:linear-gradient(135deg,#b300ff,#ff66cc);color:#fff;margin:0;padding:0;}
  .container{max-width:600px;margin:40px auto;background:rgba(255,255,255,0.1);border-radius:12px;padding:25px;box-shadow:0 0 10px rgba(0,0,0,0.3);}
  h1{text-align:center;font-weight:600;}
  label{display:block;margin-top:12px;}
  input,select,textarea{width:100%;padding:10px;border:none;border-radius:6px;margin-top:5px;}
  #card-element{padding:10px;background:#fff;color:#000;border-radius:6px;}
  button{margin-top:20px;padding:12px;width:100%;background:#ff66cc;color:#fff;border:none;border-radius:8px;font-size:16px;font-weight:600;cursor:pointer;}
  button:hover{background:#b300ff;}
  .hidden{display:none;}
  .tos{margin-top:10px;}
  .total{margin-top:15px;font-size:18px;font-weight:600;text-align:center;}
</style>
</head>
<body>
<div class="container">
  <h1>Charmers Checkout</h1>

  <form id="checkout-form">
    <label for="name">Full Name</label>
    <input id="name" required>

    <label for="email">Email</label>
    <input id="email" type="email" required>

    <label for="phone">Phone (optional)</label>
    <input id="phone">

    <label for="bracelet">Bracelet Customization Text</label>
    <textarea id="bracelet" rows="2" required></textarea>

    <!-- ðŸ“¦ USPS Shipping -->
    <label for="shipping">Shipping Option</label>
    <select id="shipping" required>
      <option value="">Select Shipping Service</option>
      <optgroup label="Domestic (USA)">
        <option value="9">USPS Ground Advantage â€” $9</option>
        <option value="13">USPS Priority Mail â€” $13</option>
        <option value="25">USPS Priority Mail Express â€” $25</option>
      </optgroup>
      <optgroup label="International (Trackable)">
        <option value="78">USPS Priority Mail International â€” $78</option>
        <option value="95">USPS Priority Mail Express International â€” $95</option>
      </optgroup>
    </select>

    <!-- âš™ï¸ CLU Processing -->
    <label for="processing">Processing Option</label>
    <select id="processing" required>
      <option value="0">CLU ground processing â€” Free</option>
      <option value="0.75">CLU priority processing â€” $0.75</option>
      <option value="1.00">CLU express processing â€” $1.00</option>
    </select>

    <!-- ðŸŒ Country / Region -->
    <label for="country">Country</label>
    <select id="country" required>
      <option value="">Select country</option>
      <option value="US">United States</option>
      <option value="CA">Canada</option>
      <option value="GB">United Kingdom</option>
      <option value="AU">Australia</option>
      <option value="JP">Japan</option>
      <option value="FR">France</option>
      <option value="DE">Germany</option>
      <option value="IN">India</option>
      <option value="BR">Brazil</option>
      <option value="ZA">South Africa</option>
    </select>

    <label id="region-label" for="region">State</label>
    <input id="region" required>

    <label for="city">City</label>
    <input id="city" required>

    <label for="address1">Street Address</label>
    <input id="address1" required>

    <label for="address2">Street Address 2 (optional)</label>
    <input id="address2">

    <label for="postal">Postal Code</label>
    <input id="postal" required>

    <div class="tos">
      <input type="checkbox" id="tos" required>
      <label for="tos">By buying from Charmers you agree to our ToS and usage policies.</label>
    </div>

    <div id="card-element"></div>
    <div class="total" id="total">Total: $0.00</div>

    <button type="submit" id="pay-btn">Complete Order</button>
  </form>

  <button id="email-btn" class="hidden">Email Order Request</button>
</div>

<script>
const stripe=Stripe("pk_live_51ReQgoHwN7YkNv6zwRaz8N1GO0PL7Bb3pqUbcxhss5cQQpJFKjoiNJR4DWKeTRWwhw2tmejOtXjbnrIg6sHnhxc600ePIEIgBc");
const elements=stripe.elements();
const card=elements.create("card");
card.mount("#card-element");

// price calc
const bracelet=document.getElementById("bracelet");
const shipping=document.getElementById("shipping");
const processing=document.getElementById("processing");
const totalDisplay=document.getElementById("total");
function calcBraceletPrice(len){if(len>100)return 0;if(len>30)return 15;if(len>12)return 10;if(len>=6)return 6;return 3;}
function updateTotal(){
 const len=bracelet.value.trim().length;
 const ship=parseFloat(shipping.value||0);
 const proc=parseFloat(processing.value||0);
 const braceletCost=calcBraceletPrice(len);
 const total=braceletCost+ship+proc+1.5; // Stripe + tax fee
 totalDisplay.textContent=`Total: $${total.toFixed(2)}`;
 return total.toFixed(2);
}
[bracelet,shipping,processing].forEach(e=>e.addEventListener("input",updateTotal));
[shipping,processing].forEach(e=>e.addEventListener("change",updateTotal));

// dynamic region labels
const regionLabel=document.getElementById("region-label");
const regionMap={
 US:"State",
 CA:"Province",
 GB:"County",
 AU:"State / Territory",
 JP:"Prefecture",
 FR:"Region",
 DE:"Bundesland",
 IN:"State / Union Territory",
 BR:"State",
 ZA:"Province"
};
document.getElementById("country").addEventListener("change",e=>{
 const code=e.target.value;
 regionLabel.textContent=regionMap[code] || "Region / State / Province";
});

// payment
document.getElementById("checkout-form").addEventListener("submit",async(e)=>{
 e.preventDefault();
 const total=updateTotal();
 document.getElementById("pay-btn").disabled=true;
 grecaptcha.enterprise.ready(async()=>{
  const token=await grecaptcha.enterprise.execute('6LeT6JArAAAAAKZDUSTu8Krw6i1sQshZnbgMoLvO',{action:'checkout'});
  const resp=await fetch("https://charmerspay.onrender.com/create-payment-intent",{
   method:"POST",headers:{"Content-Type":"application/json"},
   body:JSON.stringify({amount:Math.round(total*100),token})
  });
  const data=await resp.json();
  const {error,paymentIntent}=await stripe.confirmCardPayment(data.clientSecret,{
   payment_method:{card:card,billing_details:{name:document.getElementById("name").value,email:document.getElementById("email").value}}
  });
  if(error){alert(error.message);document.getElementById("pay-btn").disabled=false;return;}
  if(paymentIntent.status==="succeeded"){
   alert("Payment succeeded! Now press â€˜Email Order Requestâ€™."); 
   document.getElementById("email-btn").classList.remove("hidden");
   document.getElementById("pay-btn").disabled=true;
  }
 });
});

// email order
document.getElementById("email-btn").addEventListener("click",()=>{
 const name=document.getElementById("name").value;
 const email=document.getElementById("email").value;
 const phone=document.getElementById("phone").value;
 const bracelet=document.getElementById("bracelet").value;
 const total=updateTotal();
 const country=document.getElementById("country").value;
 const region=document.getElementById("region").value;
 const city=document.getElementById("city").value;
 const address1=document.getElementById("address1").value;
 const address2=document.getElementById("address2").value;
 const postal=document.getElementById("postal").value;
 const shippingOpt=document.getElementById("shipping").selectedOptions[0].text;
 const processingOpt=document.getElementById("processing").selectedOptions[0].text;
 const body=encodeURIComponent(
  `Order Details:\n\nName: ${name}\nEmail: ${email}\nPhone: ${phone}\nBracelet: ${bracelet}\nCountry: ${country}\n${regionLabel.textContent}: ${region}\nCity: ${city}\nAddress: ${address1} ${address2}\nPostal: ${postal}\nShipping: ${shippingOpt}\nProcessing: ${processingOpt}\nTotal: $${total}\n\nThank you for shopping with Charmers!`
 );
 window.location.href=`mailto:support@charmersbiz.org?subject=New Charmers Order&body=${body}`;
});
</script>
</body>
</html>
