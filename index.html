<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Charmers Checkout</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://js.stripe.com/v3/"></script>

<style>
    body {
        font-family: Arial, sans-serif;
        background: #faf5ff;
        margin: 0;
        padding: 0;
        color: #222;
    }
    header {
        background: linear-gradient(90deg, #b026ff, #ff4dd8);
        padding: 20px;
        text-align: center;
        color: white;
        font-size: 28px;
        font-weight: bold;
    }
    .container {
        max-width: 600px;
        margin: 20px auto;
        background: #fff;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 0 20px rgba(0,0,0,0.15);
    }
    label { font-weight: bold; display: block; margin-top: 12px; }
    input, select, textarea {
        width: 100%;
        padding: 10px;
        margin-top: 6px;
        border-radius: 8px;
        border: 1px solid #ccc;
    }
    button {
        width: 100%;
        padding: 15px;
        margin-top: 20px;
        background: #b026ff;
        color: white;
        border: none;
        border-radius: 10px;
        font-size: 18px;
        cursor: pointer;
    }
    button:hover {
        background: #8b1acc;
    }
    #successBox, #errorBox {
        margin-top: 20px;
        padding: 15px;
        border-radius: 10px;
        font-weight: bold;
        display: none;
    }
    #successBox { background: #d2ffda; color: #005f1a; }
    #errorBox { background: #ffd5d5; color: #7a0000; }

</style>
</head>
<body>

<header>Charmers Checkout</header>

<div class="container">

<h2>Customer Information</h2>

<label>Name</label>
<input id="nameInput">

<label>Email</label>
<input id="emailInput">

<label>Phone (optional)</label>
<input id="phoneInput">

<label>Bracelet Text</label>
<textarea id="braceletText"></textarea>

<label>Shipping Option</label>
<select id="shippingOption">
<option value="9">USPS Ground Advantage — $9</option>
<option value="11">USPS Priority Mail — $11</option>
<option value="29">USPS Priority Mail Express — $29</option>
<option value="93">UPS Worldwide Expedited — $93</option>
<option value="119">UPS Worldwide Express — $119</option>
<option value="178">USPS Priority Mail Express International — $178</option>
</select>

<label>Processing Option</label>
<select id="processingOption">
<option value="0.50">Charmers 24 Hour Processing — $0.50</option>
<option value="0">Charmers Seven Day 12 Hours — Free</option>
</select>

<label>Street Address</label>
<input id="street1">

<label>Street Address 2 (optional)</label>
<input id="street2">

<label>City</label>
<input id="city">

<label>State / Territory</label>
<input id="state">

<label>Postal Code</label>
<input id="zip">

<label>Country</label>
<input id="country" value="USA">

<h2>Payment</h2>

<div id="payment-request-button"></div>
<div id="card-element"></div>

<button id="payBtn">Complete Order</button>

<div id="successBox">Your order was processed. Expect a confirmation email from Charmers soon.</div>
<div id="errorBox"></div>

</div>

<script>
const stripe = Stripe("pk_live_51ReQgoHwN7YkNv6zwRaz8N1GO0PL7Bb3pqUbcxhss5cQQpJFKjoiNJR4DWKeTRWwhw2tmejOtXjbnrIg6sHnhxc600ePIEIgBc");

const card = stripe.elements().create("card", { hidePostalCode: true });
card.mount("#card-element");

document.getElementById("payBtn").addEventListener("click", async () => {

    const braceletText = document.getElementById("braceletText").value.trim();

    // Bracelet pricing rules
    let braceletCost = 3;
    if (braceletText.length > 100) { alert("Too many characters."); return; }
    if (braceletText.length > 30) braceletCost = 15;
    else if (braceletText.length > 12) braceletCost = 10;
    else if (braceletText.length >= 6) braceletCost = 6;

    const shipping = parseFloat(document.getElementById("shippingOption").value);
    const processingFee = parseFloat(document.getElementById("processingOption").value);

    // Fake tax + Stripe fee (undisclosed)
    const tax = braceletCost * 0.07;
    const stripeFee = (braceletCost + shipping + processingFee) * 0.029 + 0.30;

    const total = Math.round((braceletCost + shipping + processingFee + tax + stripeFee) * 100);

    const orderData = {
        name: document.getElementById("nameInput").value,
        email: document.getElementById("emailInput").value,
        phone: document.getElementById("phoneInput").value,
        braceletText,
        shipping,
        processingFee,
        street1: document.getElementById("street1").value,
        street2: document.getElementById("street2").value,
        city: document.getElementById("city").value,
        state: document.getElementById("state").value,
        zip: document.getElementById("zip").value,
        country: document.getElementById("country").value
    };

    const res = await fetch("https://Pay-Charmersv2.onrender.com/create-payment-intent", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            amount: total,
            orderDetails: orderData,
            customerInfo: orderData
        })
    });

    const data = await res.json();

    if (!data.clientSecret) {
        document.getElementById("errorBox").style.display = "block";
        document.getElementById("errorBox").textContent = "Payment failed.";
        return;
    }

    const result = await stripe.confirmCardPayment(data.clientSecret, {
        payment_method: { card }
    });

    if (result.error) {
        document.getElementById("errorBox").style.display = "block";
        if (result.error.code === "card_declined") {
            document.getElementById("errorBox").textContent = "The card was declined by your bank, try again later.";
        } else if (result.error.code === "incorrect_number") {
            document.getElementById("errorBox").textContent = "Check the card number.";
        } else {
            document.getElementById("errorBox").textContent = "Payment failed.";
        }
    } else {
        document.getElementById("successBox").style.display = "block";
    }
});
</script>

</body>
</html>
